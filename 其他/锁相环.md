# 锁相环

## 1 锁相环的基本组成

三个最基本的部件：鉴相器（Phase Detector, PD）、环路滤波器（Loop Filter, LF）、电压控制振荡器(Voltage Controlled Oscillator, VCO)，如图3-1所示。

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环01.png" alt="锁相环01" style="zoom:50%;" />

$\theta_1(t)$是输入信号的瞬时相位，单位弧度（$rad$）；$\theta_2(t)$是VCO输出信号的瞬时相位， $u_d(t)$是$\theta_1(t)$和$\theta_2(t)$的差值$\theta_e(t)$的函数（$\theta_e(t)=\theta_1(t)-\theta_2(t)$）的函数，是电压信号，单位伏特（$V$）,$u_c(t)$为$u_d(t)$经过LF滤波后的电压信号，单位为伏特（$V$）。

## 2 VCO是一个积分器

从VCO的功能上来看，它是一个电压与频率的变换装置，在环路中作为压控振荡器。其振荡控制频率随输入控制电压线性变化，变化关系可以表示为：
$$
w_v(t)=w_0+K_0u_c(t)\tag{1}
$$
$w_v(t)$是压控振荡器的瞬时角频率，单位$rad/s$，$w_0(t)$是压控振荡器在没有输入电压控制下的固有振荡角频率，$K_0$为VCO的频率控制灵敏度或增益系数，单位$rad/(s·V)$。压控振荡器的控制特性始终是线性的，超出这个范围控制灵敏度会下降，控制特性如图3-2所示，在线性控制的区域内，控制灵敏度越大，则线性区域斜率越大。

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环02.png" alt="锁相环02" style="zoom:60%;" />

锁相环关注的是输入输出信号的相位，因此，我们需要找到VCO输入电压$u_c(t)$与输出信号的相位之间的关系，对信号瞬时相位进行微分可以得到信号的瞬时频率；反之对信号的频率进行积分就可以得到信号的瞬时相位
$$
\int_{0}^{t} \omega_{\mathrm{v}}(\tau) \mathrm{d} \tau=\omega_{\mathrm{o}} t+K_{0} \int_{0}^{t} u_{\mathrm{c}}(\tau) \mathrm{d} \tau \tag{2}
$$
由上一节可知，鉴相器的输出$u_d(t)$为$\theta_1(t)$和$\theta_2(t)$的差值$\theta_e(t)$的函数，即$u_d(t)$不是与VCO的瞬时相位相关，而是与VCO和输入信号的瞬时相位差相关。可以人为设定一个基准相位（即参考相位），输入信号与输出信号的相位都与这个基准相位比较，再将比较的结果进行差值，这样不会有任何影响，还可以便于环路模型的讨论。可以讲VCO的自然振荡角频率产生的相位$w_0t$作为基准相位。

讨论式(2)，VCO以$w_0t$作为基准相位，则瞬时相位
$$
\theta_{2}(t)=K_{0} \int_{0}^{t} u_{\mathrm{c}}(\tau) \mathrm{d} \tau=\frac{K_{0}}{p} u_{\mathrm{c}}(t)\tag{3}
$$
式中，$p$是一个微分算子，则$1/p$相当于一个积分算子，所以形式上就是一个完美的积分器，VCO的输出信号可以表示为：
$$
{u_0(t)}={U_0}{sin[{w_0t}+{\theta_2(t)}]} \tag{4}
$$
式(4)中，$U_0$为VCO输出信号的幅值，单位为$V$，$\theta_2(t)$是相对于$w_0t$的相位值。

## 3 鉴相器

鉴相器是用来检测输入信号相位$\theta_1(t)$与反馈信号（VCO输出信号）$\theta_2(t)$之间的相位差$\theta_e(t)$。即只要某个装置的输出信号电压值的变化，能够直接反应相差$\theta_e(t)$的变化，就可以实现鉴相功能。最常见的是正弦形特性的鉴相器

正弦鉴相器可用乘法器和低通滤波器串联作为模型，如图3-5所示

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环03.png" alt="锁相环03" style="zoom:50%;" />

乘法器的相乘系数为$K_m$（无量纲），输入信号$u_i(t)$与反馈信号$u_0(t)$相乘的输出为
$$
\begin{aligned}
K_{\mathrm{m}} u_{\mathrm{i}}(t) u_{\mathrm{o}}(t)=& K_{\mathrm{m}} U_{\mathrm{i}} \sin \left[\omega_{\mathrm{o}} t+\theta_{1}(t)\right] U_{\mathrm{o}} \sin \left[\omega_{\mathrm{o}} t+\theta_{2}(t)\right] \\
=&-\frac{1}{2} K_{\mathrm{m}} U_{\mathrm{i}} U_{\mathrm{o}} \cos \left[2 \omega_{\mathrm{o}} t+\theta_{1}(t)+\theta_{2}(t)\right] \\
&+\frac{1}{2} K_{\mathrm{m}} U_{\mathrm{i}} U_{\mathrm{o}} \cos \left[\theta_{1}(t)-\theta_{2}(t)\right]
\end{aligned}\tag5
$$
乘法器输出结果经低通滤波器（Low Pass Filter, LPF）滤除频率为$2w_0$的高频分量后得到的误差电压
$$
\begin{aligned}
u_{\mathrm{d}}(t) &=\frac{1}{2} K_{\mathrm{m}} U_{\mathrm{i}} U_{\mathrm{o}} \cos \left[\theta_{1}(t)-\theta_{2}(t)\right] \\
&=U_{\mathrm{d}} \cos \theta_{\mathrm{e}}(t)
\end{aligned}\tag{6}
$$
式中$U_d=\frac{1}{2}K_mU_iU_o$为鉴相器的最大输出电压

## 4 环路滤波器

环路滤波器的作用有亮点：

- 低通滤波器作用，且通带要远低于鉴相器的带宽，因为VCO只有在输入纹波小的直流信号时，才能输出寄生成分小的高质量的正弦信号；
- 控制环路特性，且这才是环路滤波器的主要功能

## 5 数字环

### 双线性变化

连续时间系统$H(s)$的极点有两种情况，单重和多重，一个多重节点环节可以看成由多个单重极点环节级联构成，对二重极点的系统有
$$
H(s)=\frac{A}{(s-p)^{2}}=\frac{\sqrt{A}}{s-p} \cdot \frac{\sqrt{A}}{s-p} \tag{7}
$$
可以将一阶环节
$$
H(s)=\frac{\sqrt{A}}{s-p}=\frac{K_a}{s-p} \tag{8}
$$
看成构建$H(s)$的最基本环节，其中，$K_a$为基本环节的增益，对应一阶微分方程
$$
\frac{\mathrm{d} y(t)}{\mathrm{d} t}-p y(t)=K_{\mathrm{a}} x(t)\tag{9}
$$
结构如图7-1所示，对该系统离散化主要是对系统中的积分运算离散化

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环05.png" alt="锁相环05" style="zoom:60%;" />

一次积分运算可以用梯形作数值计算
$$
\begin{aligned}
\left.y(t)\right|_{t=n T} &=\int_{-\infty}^{n T} x(\tau) \mathrm{d} \tau \\
&=\int_{-\infty}^{(n-1) T} x(\tau) \mathrm{d} \tau+\int_{(n-1) T}^{n T} x(\tau) \mathrm{d} \tau \\
&=y[(n-1) T]+\int_{(n-1) T}^{n T} x(\tau) \mathrm{d} \tau
\end{aligned}\tag{10}
$$
将积分用梯形法近似有
$$
y(n T)=y[(n-1) T]+\frac{T}{2}\{x[(n-1) T]+x(n T)\}\tag{11}
$$
整理有
$$
y(n)=y(n-1)+\frac{T}{2}[x(n-1)+x(n)]\tag{12}
$$
取单边$z$变换，考虑到$y(n)=0,n<0$有
$$
Y(z)=z^{-1} Y(z)+\frac{T}{2}\left[z^{-1} X(z)+X(z)\right]\tag{13}
$$
整理得到一阶环节的离散系统函数
$$
H_{1}(z)=\frac{Y(z)}{X(z)}=\frac{T}{2} \cdot \frac{1+z^{-1}}{1-z^{-1}}\tag{14}
$$
即，一次积分单元离散后，是系统函数(14)描述的离散系统，对连续一阶系统离散化，得到系统结构如图7-2所示

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环06.png" alt="锁相环06" style="zoom:67%;" />

系统函数为
$$
H_{\mathrm{i}}(z)=\frac{K_{\mathrm{a}}}{\frac{2}{T} \cdot \frac{1-z^{-1}}{1+z^{-1}}-p}\tag{15}
$$

### 环路滤波器的数字化

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环07.png" alt="锁相环07" style="zoom:50%;" />

在二阶锁相环电路中，理想二阶环路具有其他两种环路无法比拟的优异性能，主要讨论这种环路滤波器，对(7-15)，令
$$
\begin{gathered}
C_{1}=\frac{2 \tau_{2}+T}{2 \tau_{1}} \\
C_{2}=\frac{T}{\tau_{1}}
\end{gathered}\tag{16}
$$
则(7-15)可以变换为
$$
F(z)=\frac{2 \tau_{2}+T}{2 \tau_{1}}+\frac{T}{\tau_{1}} \frac{z^{-1}}{1-z^{-1}}=C_{1}+\frac{C_{2} z^{-1}}{1-z^{-1}}\tag{17}
$$
对应的系统结构可用图7-3表示

<img src="/Users/ryan/Documents/notes/images/锁相环/锁相环08.png" alt="锁相环08" style="zoom:60%;" />

### NCO的数字化模型

















